<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Crawler Dashboard V4 - Hierarchy</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'JetBrains Mono', monospace; }
        .glass { background: rgba(31, 41, 55, 0.7); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen flex items-center justify-center p-5">

    <div class="w-full max-w-6xl">
        <!-- HEADER -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 mb-2 italic tracking-tighter uppercase">
                CRAWLER V4 <span class="text-white text-2xl not-italic">HIERARCHY</span>
            </h1>
            <p class="text-gray-500 text-sm tracking-[0.3em] uppercase">Kemendikdasmen Data Harvester</p>
        </div>

        <!-- MAIN STATS GRID -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Total Sekolah -->
            <div class="glass p-6 rounded-2xl border border-gray-800 shadow-2xl relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                    <svg class="w-16 h-16 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path></svg>
                </div>
                <p class="text-xs text-gray-400 font-bold uppercase mb-2 tracking-wider">Total Sekolah</p>
                <h2 id="total" class="text-5xl font-black text-white">0</h2>
            </div>

            <!-- Current Task -->
            <div class="glass p-6 rounded-2xl border border-gray-800 shadow-2xl col-span-2">
                <p class="text-xs text-gray-400 font-bold uppercase mb-2 tracking-wider">Sedang Memproses</p>
                <div class="flex items-end justify-between">
                    <div>
                        <h2 id="current_name" class="text-2xl font-bold text-blue-400 truncate max-w-md">Menunggu...</h2>
                        <p id="current_code" class="text-sm text-gray-600 mt-1 font-mono">CODE: -</p>
                    </div>
                    <span id="current_level" class="px-3 py-1 rounded bg-gray-800 text-xs font-bold text-gray-300 border border-gray-700">LEVEL -</span>
                </div>
            </div>

            <!-- Status -->
            <div class="glass p-6 rounded-2xl border border-gray-800 shadow-2xl flex flex-col justify-center items-center">
                <p class="text-xs text-gray-400 font-bold uppercase mb-2 tracking-wider">Engine Status</p>
                <h2 id="status" class="text-2xl font-black uppercase tracking-widest text-gray-500">OFFLINE</h2>
            </div>
        </div>

        <!-- QUEUE PROGRESS (HIRARKI) -->
        <div class="grid grid-cols-3 gap-4 mb-8">
            <!-- Level 1: Provinsi -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 text-center">
                <p class="text-xs text-emerald-500 font-bold uppercase mb-2">LVL 1: PROVINSI</p>
                <h3 class="text-3xl font-bold mb-1"><span id="l1_done" class="text-white">0</span> <span class="text-gray-600 text-lg">/ <span id="l1_total">0</span></span></h3>
                <div class="w-full bg-gray-800 h-1.5 rounded-full mt-3 overflow-hidden">
                    <div id="bar_l1" class="bg-emerald-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Level 2: Kabupaten -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 text-center">
                <p class="text-xs text-yellow-500 font-bold uppercase mb-2">LVL 2: KAB/KOTA</p>
                <h3 class="text-3xl font-bold mb-1"><span id="l2_done" class="text-white">0</span> <span class="text-gray-600 text-lg">/ <span id="l2_total">0</span></span></h3>
                <div class="w-full bg-gray-800 h-1.5 rounded-full mt-3 overflow-hidden">
                    <div id="bar_l2" class="bg-yellow-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>

            <!-- Level 3: Kecamatan (Harvest) -->
            <div class="bg-gray-900/50 p-6 rounded-xl border border-gray-800 text-center relative overflow-hidden">
                <div class="absolute inset-0 bg-blue-500/5 z-0"></div> <!-- Slight tint for importance -->
                <p class="text-xs text-blue-500 font-bold uppercase mb-2 relative z-10">LVL 3: KECAMATAN (PANEN)</p>
                <h3 class="text-3xl font-bold mb-1 relative z-10"><span id="l3_done" class="text-white">0</span> <span class="text-gray-600 text-lg">/ <span id="l3_total">0</span></span></h3>
                <div class="w-full bg-gray-800 h-1.5 rounded-full mt-3 overflow-hidden relative z-10">
                    <div id="bar_l3" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- CONTROLS -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <button onclick="control('/start')" class="bg-gradient-to-r from-emerald-600 to-emerald-800 hover:from-emerald-500 hover:to-emerald-700 py-6 rounded-xl font-black text-2xl shadow-lg transition transform hover:scale-[1.01] border border-emerald-500/30">
                START ENGINE
            </button>
            <button onclick="control('/pause')" class="bg-gradient-to-r from-rose-600 to-rose-800 hover:from-rose-500 hover:to-rose-700 py-6 rounded-xl font-black text-2xl shadow-lg transition transform hover:scale-[1.01] border border-rose-500/30">
                PAUSE
            </button>
        </div>

        <!-- SECONDARY CONTROLS -->
        <div class="flex gap-4">
            <a href="/enrichment" class="flex-1 bg-gray-800 hover:bg-gray-700 py-4 rounded-lg font-bold text-center text-gray-300 transition border border-gray-700 text-sm tracking-wider uppercase">
                Run Enrichment (Fase 2)
            </a>
            <a href="/viewer" class="flex-1 bg-gray-800 hover:bg-gray-700 py-4 rounded-lg font-bold text-center text-gray-300 transition border border-gray-700 text-sm tracking-wider uppercase">
                Export / View Data
            </a>
        </div>
    </div>

    <script>
        // Fungsi helper buat fetch command
        async function control(endpoint) {
            try { await fetch(endpoint); update(); } catch(e) {}
        }

        async function update(){
            try {
                const r = await fetch('/api/stats');
                const d = await r.json();

                // 1. Update Basic Stats
                document.getElementById('total').innerText = d.total.toLocaleString();
                
                // 2. Update Status Engine
                const statusEl = document.getElementById('status');
                statusEl.innerText = d.is_running ? "RUNNING..." : "PAUSED";
                statusEl.className = d.is_running 
                    ? "text-2xl font-black uppercase tracking-widest text-emerald-400 animate-pulse" 
                    : "text-2xl font-black uppercase tracking-widest text-rose-500";

                // 3. Update Current Task Info
                if (d.current_task) {
                    document.getElementById('current_name').innerText = d.current_task.nama || "Idle";
                    document.getElementById('current_code').innerText = "CODE: " + (d.current_task.kode || "-");
                    document.getElementById('current_level').innerText = "LEVEL " + (d.current_task.level || "-");
                }

                // 4. Update Hirarki Progress (Level 1, 2, 3)
                // d.queue = { l1: {done:0, total:0}, l2: {...}, l3: {...} }
                const q = d.queue;

                // Level 1
                document.getElementById('l1_done').innerText = q.l1.done;
                document.getElementById('l1_total').innerText = q.l1.total;
                document.getElementById('bar_l1').style.width = (q.l1.total > 0 ? (q.l1.done/q.l1.total)*100 : 0) + "%";

                // Level 2
                document.getElementById('l2_done').innerText = q.l2.done;
                document.getElementById('l2_total').innerText = q.l2.total;
                document.getElementById('bar_l2').style.width = (q.l2.total > 0 ? (q.l2.done/q.l2.total)*100 : 0) + "%";

                // Level 3
                document.getElementById('l3_done').innerText = q.l3.done;
                document.getElementById('l3_total').innerText = q.l3.total;
                document.getElementById('bar_l3').style.width = (q.l3.total > 0 ? (q.l3.done/q.l3.total)*100 : 0) + "%";

            } catch(e){
                console.log("API Error / Backend Offline");
            }
        }

        // Loop update setiap 1.5 detik
        setInterval(update, 1500); 
        update();
    </script>
</body>
</html>