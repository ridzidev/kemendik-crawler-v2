<!DOCTYPE html>
<html>
<head>
    <title>Fase 2 Enrichment</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-black text-green-400 p-10 font-mono tracking-wide">

<div class="max-w-6xl mx-auto">

    <h1 class="text-5xl font-black text-center mb-14 uppercase tracking-widest text-green-500">
        FASE 2 // ENRICHMENT CONTROL
    </h1>

    <div class="bg-[#070d07] border border-green-700 p-14 rounded-3xl shadow-[0_0_50px_rgba(0,255,0,0.15)] mb-12">

        <!-- PROGRESS -->
        <div class="mb-14">

            <div class="flex justify-between mb-4 text-sm text-green-600">
                <span>PROGRESS</span>
                <span id="percent-text">0%</span>
            </div>

            <div class="w-full bg-black border border-green-700 rounded-full h-10 overflow-hidden">
                <div id="progress-bar"
                     class="bg-green-500 h-10 transition-all duration-1000"
                     style="width:0%">
                </div>
            </div>

            <div class="mt-4 text-center text-green-400 text-lg">
                <span id="done-text">0</span>
                /
                <span id="total-text">0</span>
            </div>

        </div>

        <!-- STATS -->
        <div class="grid grid-cols-4 gap-12 text-center">

            <div>
                <p class="text-xs uppercase text-green-700 mb-3">Current Speed</p>
                <h2 id="speed" class="text-5xl font-black text-emerald-400">0</h2>
                <p class="text-xs text-green-700 mt-2">data / sec</p>
            </div>

            <div>
                <p class="text-xs uppercase text-green-700 mb-3">Average Speed</p>
                <h2 id="avg-speed" class="text-5xl font-black text-cyan-400">0</h2>
                <p class="text-xs text-green-700 mt-2">data / sec</p>
            </div>

            <div>
                <p class="text-xs uppercase text-green-700 mb-3">ETA</p>
                <h2 id="eta" class="text-3xl font-black text-yellow-400">--:--:--</h2>
            </div>

            <div>
                <p class="text-xs uppercase text-green-700 mb-3">Status</p>
                <h2 id="status" class="text-4xl font-black text-red-500 animate-pulse">IDLE</h2>
            </div>

        </div>

        <!-- BUTTONS -->
        <div class="mt-16 flex gap-6">
            <a href="/fase2/start"
               class="flex-1 bg-green-700 hover:bg-green-600 py-6 rounded-2xl font-black text-2xl shadow-lg text-center transition">
                START
            </a>
            <a href="/fase2/pause"
               class="flex-1 bg-red-700 hover:bg-red-600 py-6 rounded-2xl font-black text-2xl shadow-lg text-center transition">
                PAUSE
            </a>
        </div>

    </div>

</div>

<script>

let lastDone = 0;
let lastTime = Date.now();
let startTime = Date.now();

function formatTime(seconds) {
    seconds = Math.floor(seconds);

    let h = Math.floor(seconds / 3600);
    let m = Math.floor((seconds % 3600) / 60);
    let s = seconds % 60;

    return (
        String(h).padStart(2,'0') + ":" +
        String(m).padStart(2,'0') + ":" +
        String(s).padStart(2,'0')
    );
}

async function update(){
    try {
        const r = await fetch('/api/stats');
        const d = await r.json();

        // âœ… SESUAI BACKEND
        const total = d.total ?? 0;
        const done  = d.fase2_done ?? 0;

        const now = Date.now();
        const timeDiff = (now - lastTime) / 1000;
        const totalRunTime = (now - startTime) / 1000;

        const diff = done - lastDone;

        // SPEED DISKRIT
        let speed = 0;
        if (timeDiff > 0) {
            speed = Math.floor(diff / timeDiff);
        }

        let avgSpeed = 0;
        if (totalRunTime > 0) {
            avgSpeed = Math.floor(done / totalRunTime);
        }

        // STATUS
        const statusEl = document.getElementById('status');
        if (speed > 0) {
            statusEl.innerText = "RUNNING";
            statusEl.className = "text-4xl font-black text-green-400";
        } else {
            statusEl.innerText = "IDLE";
            statusEl.className = "text-4xl font-black text-red-500 animate-pulse";
        }

        // PROGRESS
        let percent = 0;
        if (total > 0) {
            percent = Math.floor((done / total) * 100);
        }

        document.getElementById('progress-bar').style.width = percent + "%";
        document.getElementById('percent-text').innerText = percent + "%";

        document.getElementById('done-text').innerText = done.toLocaleString();
        document.getElementById('total-text').innerText = total.toLocaleString();

        // ETA
        let etaText = "--:--:--";
        if (avgSpeed > 0 && total > done) {
            const remaining = total - done;
            const etaSec = remaining / avgSpeed;
            etaText = formatTime(etaSec);
        }

        document.getElementById('speed').innerText = speed;
        document.getElementById('avg-speed').innerText = avgSpeed;
        document.getElementById('eta').innerText = etaText;

        lastDone = done;
        lastTime = now;

    } catch(e){
        console.log("Stats error:", e);
    }
}

setInterval(update, 2000);
update();

</script>

</body>
</html>
